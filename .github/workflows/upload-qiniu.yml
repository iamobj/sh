name: upload qiniu

on:
  push:
    paths-ignore:
      - '.github/**'
      - 'README.md'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: 检出代码到本地
        uses: actions/checkout@v2

      # 因为七牛云命令行工具 qsuits 依赖 java 8 及以上
      - name: 安装 java jdk
        uses: actions/setup-java@v2
        with:
          java-version: '8'

      - name: 下载七牛云命令行工具 qsuits
        run: |
          # 下载 qsuits 执行器
          wget --no-check-certificate "https://github.com/NigelWu95/qsuits-exec-go/raw/master/bin/qsuits_linux_amd64"
          # 重命名为 qsuits
          mv qsuits_linux_amd64 qsuits
          # 给执行权限
          chmod +x qsuits

      # 获取 sh 文件夹下改变的文件，通过环境变量 GIT_DIFF 可以拿到文件路径
      - name: 获取 diff 文件
        uses: technote-space/get-diff-action@v4
        with: 
          PATTERNS: |
            sh/**
          SEPARATOR: ','
      
      - name: 上传到七牛云
        run: |
          ./qsuits -process=qupload -path=./ -f-suffix=${{env.GIT_DIFF}} -keep-path=false -add-prefix=sh/ -bucket=assetss -ak=${{secrets.QINIU_AK}} -sk=${{secrets.QINIU_SK}}